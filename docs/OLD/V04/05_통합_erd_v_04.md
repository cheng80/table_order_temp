# 05_통합_ERD_V04

본 문서는 V04 기준 **통합 ERD(관계 정의 기준서)** 이다.  
ERD 이미지는 별도이며, 07_DB_상세_명세_V04는 본 문서의 관계 정의를 전제로 한다.

---

## ERD 타입 범례 (Conceptual ERD)

- **[Strong Entity]**: 독립적으로 존재하는 핵심 엔티티
- **[Weak Entity]**: 상위 엔티티에 종속되는 엔티티
- **[Associative Entity]**: N:M 관계를 해소하기 위한 연관 엔티티

---

## 1. ERD 설계 원칙 (V04)

### 1.1 느슨한 결합 원칙
- 운영 엔티티(대기열, 주문, 예약)는 서로를 **강제 결합**하지 않는다.
- 필요 시에도 **선택 참조(Nullable)** 를 기본으로 한다.

### 1.2 대기열 원칙
- WAITING은 TABLE과 **직접 연결하지 않는다.**
- 호출/입장/노쇼 등 상태는 WAITING 자체에서 관리한다.

### 1.3 스냅샷 원칙 (가격/원가/날씨)
- 결제 확정 시점에 **주문 단위 스냅샷**(price_snapshot, cost_snapshot, weather_id)을 고정한다.
- 변경 이력(원가)은 **별도 로그 테이블(COST_SNAPSHOTS)** 로 관리할 수 있다.

---

## 2. 엔티티 타입 요약

### 2.1 계정/매장
- MEMBERS : [Strong Entity]
- STORES : [Weak Entity] (Parent: MEMBERS)

### 2.2 운영/대기
- STORE_TABLES : [Weak Entity] (Parent: STORES)
- WAITING_LISTS : [Weak Entity] (Parent: STORES)
- DAILY_WEATHER : [Weak Entity] (Parent: STORES)

### 2.3 메뉴/옵션
- MENU_CATEGORIES : [Weak Entity] (Parent: STORES)
- MENUS : [Weak Entity] (Parent: MENU_CATEGORIES)
- OPTION_GROUPS : [Weak Entity] (Parent: STORES)
- OPTIONS : [Weak Entity] (Parent: OPTION_GROUPS)
- MENU_OPTION_MAPPINGS : [Associative Entity]

### 2.4 주문/결제
- STORE_ORDERS : [Weak Entity] (Parent: STORES)
- ORDER_DETAILS : [Associative Entity]
- ORDER_DETAIL_OPTIONS : [Associative Entity]
- PAYMENTS : [Weak Entity] (Parent: STORE_ORDERS)

### 2.5 주방/KDS
- KDS_TICKETS : [Weak Entity] (Parent: STORE_ORDERS)

### 2.6 서비스/예약
- STAFF_CALL_ITEMS : [Weak Entity] (Parent: STORES)
- STAFF_CALL_LOGS : [Associative Entity]
- RESERVATIONS : [Weak Entity] (Parent: STORES)

### 2.7 원가 이력(분석)
- COST_SNAPSHOTS : [Weak Entity] (Parent: STORES)

---

## 3. 관계 정의 (카디널리티 · FK 방향)

> 표기: **A (1) ── (N) B** 는 B가 A의 PK를 FK로 가진다.

### 3.1 계정/매장
- MEMBERS (1) ── (N) STORES

### 3.2 매장 운영
- STORES (1) ── (N) STORE_TABLES
- STORES (1) ── (N) STAFF_CALL_ITEMS
- STORE_TABLES (1) ── (N) STAFF_CALL_LOGS
- STAFF_CALL_ITEMS (1) ── (N) STAFF_CALL_LOGS

### 3.3 대기열/날씨
- STORES (1) ── (N) WAITING_LISTS
- STORES (1) ── (N) DAILY_WEATHER
- DAILY_WEATHER (1) ── (N) STORE_ORDERS  *(선택 참조: STORE_ORDERS.weather_id Nullable 가능)*

### 3.4 메뉴/옵션
- STORES (1) ── (N) MENU_CATEGORIES
- MENU_CATEGORIES (1) ── (N) MENUS
- STORES (1) ── (N) OPTION_GROUPS
- OPTION_GROUPS (1) ── (N) OPTIONS
- MENUS (N) ── (M) OPTION_GROUPS  *(MENU_OPTION_MAPPINGS로 해소)*
- MENUS (1) ── (N) MENU_OPTION_MAPPINGS
- OPTION_GROUPS (1) ── (N) MENU_OPTION_MAPPINGS

### 3.5 주문/결제
- STORES (1) ── (N) STORE_ORDERS
- STORE_TABLES (1) ── (N) STORE_ORDERS
- STORE_ORDERS (1) ── (N) ORDER_DETAILS
- MENUS (1) ── (N) ORDER_DETAILS
- ORDER_DETAILS (1) ── (N) ORDER_DETAIL_OPTIONS
- OPTIONS (1) ── (N) ORDER_DETAIL_OPTIONS
- STORE_ORDERS (1) ── (N) PAYMENTS  *(정책에 따라 1:1로 제한 가능)*

### 3.6 주방/KDS
- STORE_ORDERS (1) ── (N) KDS_TICKETS

### 3.7 예약
- STORES (1) ── (N) RESERVATIONS
- STORE_TABLES (1) ── (N) RESERVATIONS  *(선택 참조: 좌석 선배정 시 사용)*

### 3.8 원가 이력 (FK를 실제로 ‘붙이는’ 방식)
- STORES (1) ── (N) COST_SNAPSHOTS
- MENUS (1) ── (N) COST_SNAPSHOTS *(menu_id Nullable)*
- OPTIONS (1) ── (N) COST_SNAPSHOTS *(option_id Nullable)*

> **규칙(XOR)**: COST_SNAPSHOTS는 `menu_id` 또는 `option_id` 중 **정확히 하나만** 값이 있어야 한다.  
> (단일 `target_id + target_type` 방식은 물리 FK를 걸 수 없어서, ERD 정합(‘실제 FK로 붙임’)을 원하면 위 구조가 적합)

---

## 4. ERD 정합 체크리스트

- [ ] WAITING_LISTS는 STORE_TABLES와 직접 연결되지 않는다.
- [ ] WAITING_LISTS는 STORE_ORDERS와 강제 결합되지 않는다.
- [ ] STORE_ORDERS는 STORE_TABLES 기준으로 생성된다.
- [ ] 메뉴/옵션은 N:M 매핑(MENU_OPTION_MAPPINGS)으로 구성된다.
- [ ] 결제는 주문 스냅샷(price/cost/weather) 확정을 전제로 한다.
- [ ] 전일 대기는 앱 진입 시 정리(CLOSED)될 수 있다.
- [ ] KDS_TICKETS, COST_SNAPSHOTS는 07과 동일한 FK 방향을 가진다.

