# [ì„¤ê³„] ì¸ì¦ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë° êµ¬í˜„ ê°€ì´ë“œ (v4.0)

> - **ë¬¸ì„œ ë²ˆí˜¸:** 06_auth_architecture_spec.md. 
> - **ì‘ì„± ì¼ì:** 2026.01.12. 
> - **ë²„ì „:** v4.0 (Full Integration: ë‚ ì”¨ íŠ¸ë¦¬ê±° ë° ê¸°ê¸° ë³´ì•ˆ ê°•í™”). 
> - **ì„¤ê³„ ëª©ì :** JWTì˜ ë³µì¡ì„± ì—†ì´ **MySQL DB ê¸°ë°˜ì˜ ì„¸ì…˜ í† í°(UUID)**ì„ ì‚¬ìš©í•˜ì—¬ ê°•ë ¥í•œ ì œì–´ê¶Œê³¼ ë‚ ì”¨ ë°ì´í„° ìˆ˜ì§‘ ê¸°ëŠ¥ì„ í†µí•©í•œ ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„.  

---

## 1. ê°œìš” (Overview)

ë³¸ í”„ë¡œì íŠ¸ëŠ” **Stateful Session** ë°©ì‹ì„ ì±„íƒí•œë‹¤. ì ì£¼ê°€ ë¡œê·¸ì¸í•˜ë©´ ì„œë²„ëŠ” ê³ ìœ í•œ ëœë¤ ë¬¸ìì—´(UUID)ì„ ìƒì„±í•˜ì—¬ DBì— ì €ì¥í•˜ê³  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°œê¸‰í•œë‹¤. íŠ¹íˆ, ë¡œê·¸ì¸ ì„±ê³µ ì‹œì ì€ ë‹¹ì¼ ë§¤ì¥ ìš´ì˜ì— í•„ìš”í•œ **ë‚ ì”¨ ì •ë³´ë¥¼ ìˆ˜ì§‘(ë°©ì‹ B)**í•˜ëŠ” ì¤‘ìš”í•œ íŠ¸ë¦¬ê±°ë¡œ í™œìš©ëœë‹¤.

### 1.1 ì±„íƒ ì‚¬ìœ 
1. **ë‹¨ìˆœì„± ë° ë³´ì•ˆ:** ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜ ì—†ì´ UUID ë¹„êµë§Œìœ¼ë¡œ ì¸ì¦í•˜ë©°, ì„œë²„ì—ì„œ í† í° ì‚­ì œ ì‹œ ì¦‰ì‹œ ê°•ì œ ë¡œê·¸ì•„ì›ƒì´ ê°€ëŠ¥í•˜ë‹¤.
2. **ë‚ ì”¨ ë™ê¸°í™”:** ì ì£¼ê°€ ì•±ì„ ì¼œëŠ” í–‰ìœ„ë¥¼ 'ì˜ì—… ê°œì‹œ'ë¡œ ê°„ì£¼í•˜ì—¬ ë°ì´í„° ìˆ˜ì§‘ ë¹„ìš©ì„ ìµœì í™”í•œë‹¤.
3. **ê¸°ê¸° ëª¨ë“œ ë³´í˜¸:** ê³µìš© íƒœë¸”ë¦¿(í…Œì´ë¸”/ëŒ€ê¸°ìš©)ì—ì„œ ì ì£¼ ëª¨ë“œë¡œ ì´íƒˆí•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” PIN ì¸ì¦ ì²´ê³„ë¥¼ í¬í•¨í•œë‹¤.

---

## 2. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ (Database Schema)

07ë²ˆ ëª…ì„¸ì„œì˜ `MEMBERS` í…Œì´ë¸”ì„ ê¸°ì¤€ìœ¼ë¡œ ì¸ì¦ í•„ë“œë¥¼ êµ¬ì„±í•œë‹¤.

### 2.1 MEMBERS í…Œì´ë¸” ì¸ì¦ í•„ë“œ

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì„¤ëª… |
| :--- | :--- | :--- |
| **access_token** | VARCHAR(64) | ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ìƒì„±ëœ UUID v4 (API ìš”ì²­ í—¤ë”ì— Bearerë¡œ í¬í•¨) |
| **last_login_at** | TIMESTAMP | ë§ˆì§€ë§‰ ì„¸ì…˜ ê°±ì‹  ì‹œê°„ (ì¼ì¼ ë‚ ì”¨ ìˆ˜ì§‘ ì—¬ë¶€ íŒë‹¨ì˜ ê¸°ì¤€) |

---

## 3. ì¸ì¦ í”„ë¡œì„¸ìŠ¤ ë° ë¹„ì¦ˆë‹ˆìŠ¤ íŠ¸ë¦¬ê±° (Workflow)

### 3.1 ë¡œê·¸ì¸ ë° ë‚ ì”¨ ìˆ˜ì§‘ ì‹œí€€ìŠ¤ (Method B)

```mermaid
sequenceDiagram
    participant Client as ğŸ“± ì ì£¼ ì•± (Flutter)
    participant Server as â˜ï¸ ì„œë²„ (API)
    participant DB as ğŸ—„ï¸ MySQL
    participant W_API as ğŸŒ¤ï¸ OpenWeatherMap

    Client->>Server: POST /login (ID, PW)
    Server->>DB: MEMBERS ì¡°íšŒ (login_id)
    
    alt ì¸ì¦ ì„±ê³µ
        Server->>Server: ì‹ ê·œ UUID(access_token) ìƒì„±
        Server->>DB: access_token ì €ì¥ ë° last_login_at ì—…ë°ì´íŠ¸
        
        Note over Server, DB: [ë‚ ì”¨ ìˆ˜ì§‘ ë°©ì‹ B] ì˜¤ëŠ˜ ë°ì´í„° í™•ì¸
        Server->>DB: SELECT * FROM DAILY_WEATHER WHERE target_date = TODAY
        
        opt ë°ì´í„° ë¶€ì¬ ì‹œ (ë‹¹ì¼ ìµœì´ˆ ë¡œê·¸ì¸)
            Server->>W_API: í˜„ì¬ ë‚ ì”¨ ìš”ì²­ (id, icon)
            W_API-->>Server: ë‚ ì”¨ ì •ë³´ ë°˜í™˜
            Server->>DB: DAILY_WEATHER í…Œì´ë¸”ì— ì €ì¥
        end

        Server-->>Client: 200 OK { accessToken: "UUID", storeId: 1 }
    else ì¸ì¦ ì‹¤íŒ¨
        Server-->>Client: 401 Unauthorized
    end
```

---

## 4. ê¸°ê¸° ìš´ì˜ ëª¨ë“œ ë³´ì•ˆ (Device Mode Security)

ì ì£¼ ì•±ì—ì„œ [í…Œì´ë¸” ì£¼ë¬¸ ëª¨ë“œ]ë‚˜ [ëŒ€ê¸° ë“±ë¡ ëª¨ë“œ]ë¡œ ì „í™˜ëœ íƒœë¸”ë¦¿ì€ ì¼ë°˜ ì†ë‹˜ì—ê²Œ ë…¸ì¶œë˜ë¯€ë¡œ, ê´€ë¦¬ í™”ë©´ìœ¼ë¡œì˜ ë¬´ë‹¨ ì§„ì…ì„ ë§‰ëŠ” ë³„ë„ì˜ ë³´ì•ˆ ë¡œì§ì´ í•„ìš”í•˜ë‹¤.

1. **ì¸ì¦ ìœ ì§€:** ì ì£¼ì˜ `access_token` ê¶Œí•œì„ ì„¸ì…˜ì— ìœ ì§€í•˜ì—¬ ì£¼ë¬¸/ëŒ€ê¸° ì ‘ìˆ˜ APIë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆê²Œ í•œë‹¤.
2. **ëª¨ë“œ ì´íƒˆ ì°¨ë‹¨:** íŠ¹ì • ì œìŠ¤ì²˜(ì˜ˆ: ë¡œê³  5íšŒ í„°ì¹˜) ìˆ˜í–‰ ì‹œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ì„ ë…¸ì¶œí•œë‹¤.
3. **PIN ê²€ì¦:** `STORE_TABLES.auth_code`ì™€ ëŒ€ì¡°í•˜ì—¬ ì¼ì¹˜í•  ê²½ìš°ì—ë§Œ ì ì£¼ ë©”ì¸ í™”ë©´(`O-01`)ìœ¼ë¡œ ë³µê·€ì‹œí‚¨ë‹¤.

---

## 5. êµ¬í˜„ ê°€ì´ë“œ (Client-side)

### 5.1 ì¸ì¦ ì¸í„°ì…‰í„° ë° ë‚ ì”¨ ì²˜ë¦¬ (Dart ì˜ˆì‹œ)

```dart
// API ìš”ì²­ ì‹œ í—¤ë”ì— í† í° ìë™ í¬í•¨
Future<Map<String, String>> getHeaders() async {
  final prefs = await SharedPreferences.getInstance();
  final token = prefs.getString('access_token');
  return {
    'Authorization': 'Bearer $token',
    'Content-Type': 'application/json',
  };
}

// ë¡œê·¸ì¸ ì„±ê³µ í›„ ì²˜ë¦¬
if (response.statusCode == 200) {
  saveToken(response.data['accessToken']);
  // ì„œë²„ì—ì„œ ë‚ ì”¨ ìˆ˜ì§‘ì´ ì™„ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ ëŒ€ì‹œë³´ë“œ ì§„ì… ì‹œ ìµœì‹  ë‚ ì”¨ ë°”ë¡œ ë¡œë“œ ê°€ëŠ¥
  navigateToDashboard();
}
```

---

## 6. ì°¸ê³  ìë£Œ (References)

ë³¸ ì•„í‚¤í…ì²˜ ìˆ˜ë¦½ì— ì°¸ê³ í•œ í•µì‹¬ ìë£Œì…ë‹ˆë‹¤.

1. **[YouTube] Flutter ìƒíƒœ ê´€ë¦¬ì™€ ë¡œì»¬ DB ì—†ëŠ” êµ¬ì¡°**
    * ì„¤ëª…: ë¡œì»¬ DB(SQLite) ì—†ì´ ì„œë²„ APIì™€ ìƒíƒœ ê´€ë¦¬ë§Œìœ¼ë¡œ ì•±ì„ êµ¬ì„±í•˜ëŠ” 'Thin Client' ì•„í‚¤í…ì²˜ ê°œë… ì„¤ëª….
    * ë§í¬: [í”ŒëŸ¬í„° ì•±ì˜ ìƒíƒœ ê´€ë¦¬ì™€ ì•„í‚¤í…ì²˜ (Click)](https://www.youtube.com/watch?v=t3CF4i902I8)

2. **[Docs] SharedPreferences (Flutter Package)**
    * ì„¤ëª…: ì¸ì¦ í† í° ë° ê¸°ê¸° ì„¤ì •ê°’ì„ ì˜êµ¬ ì €ì¥í•˜ê¸° ìœ„í•œ íŒ¨í‚¤ì§€ ê°€ì´ë“œ.
    * ë§í¬: [pub.dev/packages/shared_preferences](https://pub.dev/packages/shared_preferences)

3. **[Docs] MySQL UUID Reference**
    * ì„¤ëª…: MySQLì—ì„œ ì•ˆì „í•œ ê³ ìœ  ì‹ë³„ì(UUID)ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë°©ë²•.
    * ë§í¬: [MySQL 8.0 Reference - UUID](https://dev.mysql.com/doc/refman/8.0/en/miscellaneous-functions.html#function_uuid)

---
