# 주문 → 결제 → KDS 데이터 흐름 예시 (V03 기준)

이 문서는 **최신 V03 설계 문서(우마이 카레 시나리오)**를 기준으로,
손님 유입(대기열) → 주문 → 결제 → 주방(KDS) 전달까지의 전 과정을
**더미 데이터와 테이블 단위 설명**으로 한 번에 이해할 수 있도록 정리한 기준 문서다.

이 문서 한 장만 보면 다음을 파악할 수 있다.
- 주문의 기준 단위가 무엇인지
- 메뉴/옵션/원가 정보가 어디에 고정되는지
- 결제는 어떤 시점과 기준으로 생성되는지
- KDS에는 어떤 데이터만 전달되는지

---

## 0. 주문 시나리오 정의 (현실 예시)

### 매장 상황
- 매장명: **우마이 카레**
- 날씨: 비 (점주 로그인 시 수집)
- 대기번호: **W-023**
- 테이블: **5번 테이블**

### 주문 메뉴
1. 기본 카레 × 1
   - 맵기: 보통
   - 토핑: 치즈 추가
2. 치킨 카레 × 1
   - 맵기: 매운맛
3. 기본 카레 × 1
   - 맵기: 순한맛
   - 토핑: 계란 추가

---

## 1. 대기열 등록 (reservations)

> 매장 입구에서 대기 등록 시 생성되는 데이터

```sql
reservations
--------------------------------------------------
reservation_id | waiting_no | status  | created_at
--------------------------------------------------
R_023          | W-023      | CALLED  | 18:42
```

### 설명
- 대기열은 **주문 이전 유입 단계 데이터**
- 주문/결제와 직접 결합하지 않음
- 주문 시점에 참조만 가능

---

## 2. store_orders (주문 묶음 생성)

> 손님이 테이블에서 주문을 확정하는 순간 생성되는 **최상위 주문 컨테이너**

```sql
store_orders
----------------------------------------------------------------
store_order_id | table_no | reservation_id | weather_id | status
----------------------------------------------------------------
SO_2001        | 5        | R_023          | WTH_0112   | ORDERED
```

### 설명
- `store_order_id`는 이후 모든 흐름의 기준 키
- `reservation_id`는 대기 데이터 참조용
- `weather_id`는 로그인 시 수집된 날씨 스냅샷

---

## 3. order_details (메뉴 단위 + 원가 스냅샷)

> **메뉴 1개 = order_details 1행**

```sql
order_details
--------------------------------------------------------------------------------
order_detail_id | store_order_id | menu_name | price_snapshot | cost_snapshot
--------------------------------------------------------------------------------
OD_201          | SO_2001        | 기본 카레 | 9000           | 3900
OD_202          | SO_2001        | 치킨 카레 | 9000           | 4200
OD_203          | SO_2001        | 기본 카레 | 8800           | 3800
```

### 설명
- `price_snapshot`
  - 메뉴 가격 + 옵션 가격이 합산된 최종 판매가
- `cost_snapshot`
  - 메뉴 원가 + 옵션 원가가 합산된 실제 비용
- 이후 가격/원가 변경과 완전히 분리됨

---

## 4. order_detail_options (옵션 스냅샷)

> 선택된 옵션 1개당 1행

```sql
order_detail_options
---------------------------------------------------------------------------
order_detail_id | option_name | price_snapshot | cost_snapshot
---------------------------------------------------------------------------
OD_201          | 치즈 추가   | 1000           | 400
OD_203          | 계란 추가   | 800            | 300
```

### 설명
- 옵션 정의 테이블과 완전히 분리된 스냅샷 데이터
- 옵션 삭제/가격 변경이 과거 주문에 영향을 주지 않음

---

## 5. 결제 생성 (payments)

> 손님이 결제를 완료하면 **주문 묶음(store_orders)** 기준으로 생성

```sql
payments
---------------------------------------------------------------------------
payment_id | store_order_id | total_amount | total_cost | net_profit
---------------------------------------------------------------------------
PAY_3001   | SO_2001        | 26800        | 12400      | 14400
```

### 설명
- `total_amount` : 결제된 총 금액
- `total_cost`   : 해당 주문의 실제 총 원가
- `net_profit`   : 순이익 (통계/대시보드 기준값)

---

## 6. KDS로 전달되는 데이터

> KDS는 **결제 완료된 주문** 기준으로
`order_details` + `order_detail_options`만 조회한다.

```text
[5번 테이블 / 대기번호 W-023]

- 기본 카레
  · 맵기: 보통
  · 치즈 추가

- 치킨 카레
  · 맵기: 매운맛

- 기본 카레
  · 맵기: 순한맛
  · 계란 추가
```

### 중요한 포인트
- KDS에는 **날씨, 원가, 결제 정보가 전달되지 않는다**
- 조리에 필요한 정보만 존재

---

## 7. 전체 흐름 요약 (V03)

```text
대기 등록
   ↓
호출
   ↓
주문(store_orders)
   ↓
메뉴/옵션 스냅샷 저장
   ↓
결제 + 원가 확정
   ↓
KDS 전달
   ↓
날씨 · 대기 · 순이익 통계
```

---

## 8. 이 문서의 역할

- 팀 내부 공통 이해 기준 문서
- 주문/결제/KDS 데이터 흐름 설명용
- ERD · API · 화면 설계 문서와의 연결 기준

이 문서는 **V03 전체 문서(01~07)를 관통하는 주문 흐름 기준 예시 문서**로 사용한다.

